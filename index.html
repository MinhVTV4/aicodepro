<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI No-Code Platform - Giai ƒëo·∫°n 4</title>
    
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        button { transition: all 0.3s ease; }
        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 6px 10px -1px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.08);
        }
        .list-item {
            transition: all 0.2s ease;
            border: 1px solid #374151;
        }
        .list-item:hover {
            background-color: #1f2937;
            border-color: #4f46e5;
        }
        .list-item.selected {
             background-color: #3730a3;
             border-left: 4px solid #6366f1;
             border-color: #4f46e5;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #previewModal iframe { width: 100%; height: 100%; border: none; }
        #previewModal.visual-edit-mode #previewModalContent {
            width: 100vw;
            height: 100vh;
            max-width: 100vw;
            border-radius: 0;
        }
        #fileEditorGroup { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gray-800 text-white p-4 shadow-lg flex justify-between items-center border-b border-gray-700">
        <h1 class="text-3xl font-bold">AI "Ngh·ªá sƒ©" Platform</h1>
        <div id="authStatus" class="flex items-center space-x-4">
            <span id="userEmailDisplay" class="text-lg font-medium hidden"></span>
            <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hidden">ƒêƒÉng xu·∫•t</button>
        </div>
    </header>

    <!-- Auth Section -->
    <div id="authSection" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-md border border-gray-700">
            <h2 class="text-3xl font-bold mb-6 text-center text-white">ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</h2>
            <div class="mb-4">
                <label for="emailInput" class="block text-gray-300 text-base font-bold mb-2">Email:</label>
                <input type="email" id="emailInput" placeholder="your@example.com" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="mb-6">
                <label for="passwordInput" class="block text-gray-300 text-base font-bold mb-2">M·∫≠t kh·∫©u:</label>
                <input type="password" id="passwordInput" placeholder="********" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="loginBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg shadow-md flex-grow">ƒêƒÉng nh·∫≠p</button>
                <button id="registerBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg shadow-md flex-grow">ƒêƒÉng k√Ω</button>
            </div>
            <p class="text-red-500 text-sm mt-4 text-center" id="authErrorMsg"></p>
        </div>
    </div>

    <!-- Main App Content -->
    <main id="mainAppContent" class="flex-grow container mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 hidden">
        
        <!-- C·ªôt Tr√°i: Qu·∫£n l√Ω d·ª± √°n -->
        <section class="bg-gray-800 p-6 rounded-lg shadow-md col-span-1 lg:col-span-3 flex flex-col border border-gray-700 space-y-6">
            <div>
                <h2 class="text-2xl font-semibold mb-4 text-white">Applications</h2>
                <button id="addNewAppBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md mb-4 w-full">T·∫°o ·ª©ng d·ª•ng m·ªõi</button>
                <div id="applicationsList" class="space-y-3 max-h-40 overflow-y-auto pr-2"></div>
            </div>
            <div id="myPagesSection" class="border-t border-gray-700 pt-6">
                <h2 class="text-2xl font-semibold mb-4 text-white">C√°c trang c·ªßa t√¥i</h2>
                <div id="myPagesList" class="space-y-3 max-h-40 overflow-y-auto pr-2"></div>
            </div>
            <div id="changeHistorySection" class="border-t border-gray-700 pt-6 flex-grow flex flex-col">
                <h2 class="text-2xl font-semibold mb-4 text-white">L·ªãch s·ª≠ thay ƒë·ªïi</h2>
                <div id="changeHistoryList" class="space-y-3 flex-grow overflow-y-auto pr-2"></div>
            </div>
        </section>

        <!-- C·ªôt ph·∫£i: AI Canvas -->
        <section class="bg-gray-800 p-8 rounded-xl shadow-2xl col-span-1 lg:col-span-9 flex flex-col border border-gray-700">
            
            <div class="text-center mb-6">
                 <button id="visualEditBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-4 px-8 rounded-lg shadow-lg text-lg w-full">Ch·∫ø ƒë·ªô Ch·ªânh s·ª≠a Tr·ª±c quan</button>
            </div>
            
            <!-- GIAI ƒêO·∫†N 4: N√¢ng c·∫•p th·∫©m m·ªπ -->
            <div id="designStudioSection" class="bg-gray-900 p-6 rounded-xl border border-gray-700 shadow-lg mb-6">
                <h3 class="text-xl font-bold text-white mb-4">üé® Design Studio</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="designStyleSelect" class="block text-gray-300 text-base font-bold mb-2">1. Ch·ªçn Phong c√°ch Ch·ªß ƒë·∫°o</label>
                        <select id="designStyleSelect" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="default">T·ªëi gi·∫£n & Hi·ªán ƒë·∫°i</option>
                            <option value="corporate">Chuy√™n nghi·ªáp & Doanh nghi·ªáp</option>
                            <option value="creative">S√°ng t·∫°o & ƒê·ªôt ph√°</option>
                            <option value="elegant">Trang nh√£ & Sang tr·ªçng</option>
                        </select>
                    </div>
                    <div>
                        <label for="globalStylePromptInput" class="block text-gray-300 text-base font-bold mb-2">2. Tinh ch·ªânh Phong c√°ch</label>
                        <div class="flex gap-2">
                           <input id="globalStylePromptInput" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="VD: 'd√πng m√†u xanh navy l√†m ch·ªß ƒë·∫°o'"/>
                           <button id="applyGlobalStyleBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex-shrink-0">√Åp d·ª•ng</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700 shadow-lg flex-grow flex flex-col">
                 <label for="aiPromptInput" class="block text-gray-300 text-base font-bold mb-2">3. Y√™u c·∫ßu cho AI Ki·∫øn tr√∫c s∆∞</label>
                 <textarea id="aiPromptInput" rows="3" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 flex-grow" placeholder="M√¥ t·∫£ √Ω t∆∞·ªüng c·ªßa b·∫°n... VD: 'l√†m cho t√¥i m·ªôt trang portfolio nhi·∫øp ·∫£nh'"></textarea>
                 <button id="sendToAIButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg shadow-md mt-4 w-full flex items-center justify-center gap-2">
                    <span id="aiButtonText">G·ª≠i t·ªõi AI</span>
                    <div id="aiButtonSpinner" class="spinner hidden"></div>
                </button>
            </div>
            <div id="fileEditorGroup"><code id="editableCodeContent"></code></div>
        </section>
    </main>

    <!-- Modals -->
    <div id="messageBox" class="fixed bottom-4 right-4 bg-gray-200 text-gray-900 px-6 py-3 rounded-lg shadow-lg hidden z-50 opacity-0"></div>
    <div id="addNewAppModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-md border border-gray-700">
            <h3 class="text-2xl font-bold mb-6 text-white">T·∫°o ·ª©ng d·ª•ng m·ªõi</h3>
            <div class="mb-4">
                <label for="newAppNameInput" class="block text-gray-300 text-base font-bold mb-2">T√™n ·ª©ng d·ª•ng:</label>
                <input type="text" id="newAppNameInput" placeholder="V√≠ d·ª•: 'Blog c√° nh√¢n'" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancelNewAppBtn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">H·ªßy</button>
                <button id="confirmNewAppBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">T·∫°o</button>
            </div>
        </div>
    </div>
    <div id="previewModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-0 hidden z-50">
        <div id="previewModalContent" class="bg-white rounded-lg shadow-2xl w-full h-full flex flex-col relative"> 
            <button id="closePreviewBtn" class="absolute top-4 right-4 text-white bg-black bg-opacity-50 hover:bg-opacity-75 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold z-20">&times;</button>
            <iframe id="previewFrame" title="Visual Edit Content"></iframe>
        </div>
    </div>
    <div id="aiPlanModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-2xl border border-gray-700">
            <h3 class="text-2xl font-bold mb-4 text-white">K·∫ø ho·∫°ch c·ªßa AI Ki·∫øn tr√∫c s∆∞</h3>
            <p id="aiPlanDescription" class="text-gray-300 mb-6"></p>
            <div id="aiPlanFiles" class="space-y-3 mb-6 border-t border-b border-gray-700 py-4"></div>
            <div class="flex justify-end gap-4">
                <button id="cancelAiPlanBtn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">H·ªßy</button>
                <button id="confirmAiPlanBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                    <span id="confirmAiPlanBtnText">B·∫Øt ƒë·∫ßu x√¢y d·ª±ng</span>
                    <div id="confirmAiPlanSpinner" class="spinner hidden"></div>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, getDoc, onSnapshot, query, orderBy, setDoc, updateDoc, deleteDoc, where, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-ai.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDn5kQei_GxhUCJ4i1CVytiWla3vqpVGWI",
            authDomain: "aicodepro.firebaseapp.com",
            projectId: "aicodepro",
            storageBucket: "aicodepro.firebasestorage.app",
            messagingSenderId: "905071307012",
            appId: "1:905071307012:web:c242d96fb6aa4807154851"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let aiModel;
        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            aiModel = getGenerativeModel(ai, { model: "gemini-2.5-flash" });
        } catch (e) { console.error("AI Init Error:", e); }

        let currentAppId = null, currentVersionId = null, userId = null;
        let currentFiles = new Map();
        let lastSelectedElementSelector = null;
        let proposedPlan = null;

        const elements = {
            authSection: document.getElementById('authSection'), mainAppContent: document.getElementById('mainAppContent'),
            emailInput: document.getElementById('emailInput'), passwordInput: document.getElementById('passwordInput'),
            loginBtn: document.getElementById('loginBtn'), registerBtn: document.getElementById('registerBtn'),
            logoutBtn: document.getElementById('logoutBtn'), userEmailDisplay: document.getElementById('userEmailDisplay'),
            applicationsList: document.getElementById('applicationsList'), myPagesList: document.getElementById('myPagesList'),
            changeHistoryList: document.getElementById('changeHistoryList'), visualEditBtn: document.getElementById('visualEditBtn'),
            designStyleSelect: document.getElementById('designStyleSelect'), // Giai ƒëo·∫°n 4
            globalStylePromptInput: document.getElementById('globalStylePromptInput'), applyGlobalStyleBtn: document.getElementById('applyGlobalStyleBtn'),
            aiPromptInput: document.getElementById('aiPromptInput'), sendToAIButton: document.getElementById('sendToAIButton'),
            aiButtonText: document.getElementById('aiButtonText'), aiButtonSpinner: document.getElementById('aiButtonSpinner'),
            editableCodeContent: document.getElementById('editableCodeContent'), messageBox: document.getElementById('messageBox'),
            messageContent: document.getElementById('messageContent'), addNewAppBtn: document.getElementById('addNewAppBtn'),
            addNewAppModal: document.getElementById('addNewAppModal'), newAppNameInput: document.getElementById('newAppNameInput'),
            confirmNewAppBtn: document.getElementById('confirmNewAppBtn'), cancelNewAppBtn: document.getElementById('cancelNewAppBtn'),
            previewModal: document.getElementById('previewModal'), closePreviewBtn: document.getElementById('closePreviewBtn'),
            previewFrame: document.getElementById('previewFrame'), aiPlanModal: document.getElementById('aiPlanModal'),
            aiPlanDescription: document.getElementById('aiPlanDescription'), aiPlanFiles: document.getElementById('aiPlanFiles'),
            confirmAiPlanBtn: document.getElementById('confirmAiPlanBtn'), cancelAiPlanBtn: document.getElementById('cancelAiPlanBtn'),
            confirmAiPlanBtnText: document.getElementById('confirmAiPlanBtnText'), confirmAiPlanSpinner: document.getElementById('confirmAiPlanSpinner'),
        };

        function showMessage(msg, duration = 3000) {
             elements.messageContent.textContent = msg;
            elements.messageBox.classList.remove('hidden', 'opacity-0');
            elements.messageBox.classList.add('opacity-100');
            setTimeout(() => {
                elements.messageBox.classList.remove('opacity-100');
                setTimeout(() => elements.messageBox.classList.add('hidden'), 300);
            }, duration);
        }

        function setMainAiLoading(isLoading, text = 'G·ª≠i t·ªõi AI') {
            elements.aiButtonText.textContent = text;
            elements.aiButtonSpinner.classList.toggle('hidden', !isLoading);
            elements.sendToAIButton.disabled = isLoading;
            elements.applyGlobalStyleBtn.disabled = isLoading;
        }

        function setGlobalStyleLoading(isLoading) {
            const btn = elements.applyGlobalStyleBtn;
            btn.disabled = isLoading;
            if (isLoading) {
                btn.innerHTML = `<div class="flex items-center justify-center gap-2"><span>ƒêang √°p d·ª•ng...</span><div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div></div>`;
            } else {
                btn.textContent = '√Åp d·ª•ng';
            }
            elements.sendToAIButton.disabled = isLoading;
        }

        onAuthStateChanged(auth, user => {
            const isLoggedIn = !!user;
            elements.authSection.classList.toggle('hidden', isLoggedIn);
            elements.mainAppContent.classList.toggle('hidden', !isLoggedIn);
            if (isLoggedIn) {
                userId = user.uid;
                elements.userEmailDisplay.textContent = user.email || "Anonymous";
                loadApplications();
            } else {
                userId = null;
            }
            elements.userEmailDisplay.classList.toggle('hidden', !isLoggedIn);
            elements.logoutBtn.classList.toggle('hidden', !isLoggedIn);
        });
        
        const handleAuth = async (isRegister) => {
            const email = elements.emailInput.value.trim();
            const password = elements.passwordInput.value.trim();
            try {
                if (isRegister) await createUserWithEmailAndPassword(auth, email, password);
                else await signInWithEmailAndPassword(auth, email, password);
            } catch (error) { showMessage(error.message); }
        };

        const getCollections = {
            applications: () => collection(db, `users/${userId}/applications`),
            versions: (appId) => collection(db, `users/${userId}/applications/${appId}/versions`),
            files: (appId, versionId) => collection(db, `users/${userId}/applications/${appId}/versions/${versionId}/files`)
        };

        const loadApplications = () => {
            if (!userId) return;
            const q = query(getCollections.applications(), orderBy('createdAt', 'desc'));
            onSnapshot(q, snapshot => {
                elements.applicationsList.innerHTML = snapshot.empty ? '<div class="text-gray-400 text-center py-4">T·∫°o ·ª©ng d·ª•ng ƒë·∫ßu ti√™n.</div>' : '';
                snapshot.forEach(doc => {
                    const appData = { id: doc.id, ...doc.data() };
                    const appItem = document.createElement('div');
                    appItem.className = `list-item p-3 rounded-lg cursor-pointer`;
                    if (appData.id === currentAppId) appItem.classList.add('selected');
                    appItem.dataset.appId = appData.id;
                    appItem.textContent = appData.name;
                    elements.applicationsList.appendChild(appItem);
                });
            });
        };

        const selectApplication = (appId) => {
            currentAppId = appId;
            document.querySelectorAll('#applicationsList > div').forEach(el => el.classList.remove('selected'));
            document.querySelector(`#applicationsList [data-app-id="${appId}"]`).classList.add('selected');
            loadPagesAndHistory(appId);
        };

        const loadPagesAndHistory = (appId) => {
            if (!userId || !appId) return;
            const q = query(getCollections.versions(appId), orderBy('timestamp', 'desc'));
            onSnapshot(q, async (snapshot) => {
                elements.changeHistoryList.innerHTML = snapshot.empty ? '<div class="text-gray-400 text-center py-4">Ch∆∞a c√≥ thay ƒë·ªïi.</div>' : '';
                snapshot.forEach(doc => {
                    const version = doc.data();
                    const item = document.createElement('div');
                    item.className = 'list-item p-3 rounded-lg cursor-pointer';
                    if (doc.id === currentVersionId) item.classList.add('selected');
                    item.dataset.versionId = doc.id;
                    item.innerHTML = `<p class="font-medium text-gray-300 text-sm">${version.notes || 'Thay ƒë·ªïi nh·ªè'}</p><p class="text-xs text-gray-500">${new Date(version.timestamp).toLocaleString()}</p>`;
                    elements.changeHistoryList.appendChild(item);
                });

                if (!snapshot.empty) {
                    const latestVersionId = snapshot.docs[0].id;
                    if (currentVersionId !== latestVersionId) {
                        await selectVersion(appId, latestVersionId, true);
                    }
                } else {
                    renderMyPages();
                }
            });
        };

        const selectVersion = async (appId, versionId, isLatest = false) => {
            currentVersionId = versionId;
            document.querySelectorAll('#changeHistoryList > div').forEach(el => el.classList.remove('selected'));
            const versionElement = document.querySelector(`#changeHistoryList [data-version-id="${versionId}"]`);
            if(versionElement) versionElement.classList.add('selected');

            const filesSnapshot = await getDocs(getCollections.files(appId, versionId));
            currentFiles.clear();
            filesSnapshot.forEach(doc => currentFiles.set(doc.data().filename, doc.data().content));
            
            const firstPageName = [...currentFiles.keys()].find(k => k.endsWith('.html')) || '';
            elements.editableCodeContent.textContent = currentFiles.get(firstPageName) || '';

            if (isLatest) {
                renderMyPages();
            }
        };
        
        const renderMyPages = () => {
            elements.myPagesList.innerHTML = '';
            const htmlFiles = [...currentFiles.keys()].filter(k => k.endsWith('.html'));
            if (htmlFiles.length === 0) {
                 elements.myPagesList.innerHTML = '<div class="text-gray-400 text-center py-4">Ch∆∞a c√≥ trang n√†o.</div>';
                 return;
            }
            htmlFiles.forEach(filename => {
                const pageItem = document.createElement('div');
                pageItem.className = 'list-item p-3 rounded-lg cursor-pointer';
                pageItem.textContent = filename;
                pageItem.dataset.filename = filename;
                elements.myPagesList.appendChild(pageItem);
            });
        };

        const saveMultiFileVerson = async (filesMap, note) => {
            if (!userId || !currentAppId) return showMessage("Vui l√≤ng ch·ªçn m·ªôt ·ª©ng d·ª•ng.");
            
            const batch = writeBatch(db);
            const versionsQuery = query(getCollections.versions(currentAppId));
            const versionsSnapshot = await getDocs(versionsQuery);
            const newVersionIndex = versionsSnapshot.size + 1;
            
            const newVersionRef = doc(collection(db, `users/${userId}/applications/${currentAppId}/versions`));
            batch.set(newVersionRef, {
                versionIndex: newVersionIndex, notes: note, timestamp: Date.now(), parentVersionId: currentVersionId,
            });

            for (const [filename, content] of filesMap.entries()) {
                const fileRef = doc(collection(db, `users/${userId}/applications/${currentAppId}/versions/${newVersionRef.id}/files`));
                batch.set(fileRef, { filename, content });
            }
            
            await batch.commit();
            showMessage(`ƒê√£ l∆∞u phi√™n b·∫£n m·ªõi: ${note}`);
        };

        function createInjectorScript() { /* ... same as before ... */ return `...`; }
        const enterVisualEditMode = () => { /* ... same as before ... */ };
        
        // --- AI "Artist" Logic ---
        const getDesignStyleContext = () => {
            const styleValue = elements.designStyleSelect.value;
            const stylePrompts = {
                'default': "Phong c√°ch thi·∫øt k·∫ø: T·ªëi gi·∫£n, hi·ªán ƒë·∫°i. S·ª≠ d·ª•ng font sans-serif, nhi·ªÅu kh√¥ng gian tr·∫Øng, b·∫£ng m√†u trung t√≠nh.",
                'corporate': "Phong c√°ch thi·∫øt k·∫ø: Chuy√™n nghi·ªáp, doanh nghi·ªáp. S·ª≠ d·ª•ng font sans-serif, b·ªë c·ª•c d·∫°ng l∆∞·ªõi, b·∫£ng m√†u xanh d∆∞∆°ng v√† x√°m, t·∫°o c·∫£m gi√°c tin c·∫≠y.",
                'creative': "Phong c√°ch thi·∫øt k·∫ø: S√°ng t·∫°o, ƒë·ªôt ph√°. S·ª≠ d·ª•ng m√†u s·∫Øc t√°o b·∫°o, font ch·ªØ ƒë·ªôc ƒë√°o, b·ªë c·ª•c b·∫•t ƒë·ªëi x·ª©ng v√† c√°c hi·ªáu ·ª©ng animation.",
                'elegant': "Phong c√°ch thi·∫øt k·∫ø: Trang nh√£, sang tr·ªçng. S·ª≠ d·ª•ng font serif, h√¨nh ·∫£nh l·ªõn, ch·∫•t l∆∞·ª£ng cao, b·∫£ng m√†u pastel ho·∫∑c ƒë∆°n s·∫Øc, v√† c√°c hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªông m∆∞·ª£t m√†."
            };
            return stylePrompts[styleValue];
        }

        const isMajorProjectRequest = (prompt) => {
            const keywords = ['website', 'trang web', 'portfolio', 'blog', 'c·ª≠a h√†ng', 'shop', 'd·ª± √°n', 'platform'];
            return keywords.some(keyword => prompt.toLowerCase().includes(keyword));
        };

        const handleAiRequest = async () => {
            const userPrompt = elements.aiPromptInput.value.trim();
            if (!userPrompt) return showMessage("Vui l√≤ng nh·∫≠p y√™u c·∫ßu.");
            if (!currentAppId) return showMessage("Vui l√≤ng t·∫°o ho·∫∑c ch·ªçn m·ªôt ·ª©ng d·ª•ng tr∆∞·ªõc.");
            
            setMainAiLoading(true, 'AI ƒëang suy nghƒ©...');
            const designContext = getDesignStyleContext();

            try {
                if (lastSelectedElementSelector) {
                    await handleVisualEdit(userPrompt, designContext);
                } else if (isMajorProjectRequest(userPrompt)) {
                    await handleProjectPlanning(userPrompt, designContext);
                } else {
                    await handleGeneralModification(userPrompt, designContext);
                }
            } catch (error) {
                console.error("AI Error:", error);
                showMessage(`L·ªói AI: ${error.message}`, 5000);
            } finally {
                setMainAiLoading(false);
                lastSelectedElementSelector = null;
                elements.aiPromptInput.value = '';
                elements.aiPromptInput.placeholder = "M√¥ t·∫£ √Ω t∆∞·ªüng c·ªßa b·∫°n...";
            }
        };
        
        const handleProjectPlanning = async (prompt, designContext) => {
            const instruction = `B·∫°n l√† m·ªôt ki·∫øn tr√∫c s∆∞ web v·ªõi gu th·∫©m m·ªπ cao. Ph√¢n t√≠ch y√™u c·∫ßu c·ªßa ng∆∞·ªùi d√πng v√† ƒë·ªÅ xu·∫•t m·ªôt k·∫ø ho·∫°ch x√¢y d·ª±ng trang web.
            Y√äU C·∫¶U C·ª¶A NG∆Ø·ªúI D√ôNG: "${prompt}"
            PHONG C√ÅCH THI·∫æT K·∫æ B·∫ÆT BU·ªòC: "${designContext}"
            Nhi·ªám v·ª•: Tr·∫£ l·ªùi D∆Ø·ªöI D·∫†NG m·ªôt ƒë·ªëi t∆∞·ª£ng JSON duy nh·∫•t. JSON ph·∫£i c√≥ thu·ªôc t√≠nh "description" (l·ªùi ch√†o v√† m√¥ t·∫£ k·∫ø ho·∫°ch) v√† "files" (m·ªôt m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng, m·ªói ƒë·ªëi t∆∞·ª£ng c√≥ "name" v√† "purpose").`;
            
            try {
                const result = await aiModel.generateContent(instruction);
                const jsonString = (await result.response).text().replace(/```json|```/g, '').trim();
                proposedPlan = JSON.parse(jsonString);
                
                elements.aiPlanDescription.textContent = proposedPlan.description;
                elements.aiPlanFiles.innerHTML = '';
                proposedPlan.files.forEach(file => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'bg-gray-700 p-3 rounded-md';
                    fileDiv.innerHTML = `<p class="font-semibold text-white">${file.name}</p><p class="text-sm text-gray-400">${file.purpose}</p>`;
                    elements.aiPlanFiles.appendChild(fileDiv);
                });
                elements.aiPlanModal.classList.remove('hidden');

            } catch (e) {
                console.error("L·ªói khi l·∫≠p k·∫ø ho·∫°ch:", e);
                showMessage("AI kh√¥ng th·ªÉ l·∫≠p k·∫ø ho·∫°ch. Vui l√≤ng th·ª≠ m·ªôt y√™u c·∫ßu kh√°c r√µ r√†ng h∆°n.");
            } finally {
                setMainAiLoading(false);
            }
        };
        
        const handleScaffolding = async () => {
            if (!proposedPlan) return;
            const btnText = elements.confirmAiPlanBtnText;
            const spinner = elements.confirmAiPlanSpinner;
            btnText.textContent = 'ƒêang x√¢y d·ª±ng...';
            spinner.classList.remove('hidden');
            elements.confirmAiPlanBtn.disabled = true;
            const designContext = getDesignStyleContext();

            const instruction = `B·∫°n l√† m·ªôt l·∫≠p tr√¨nh vi√™n web chuy√™n nghi·ªáp v·ªõi gu th·∫©m m·ªπ tinh t·∫ø. D·ª±a tr√™n k·∫ø ho·∫°ch sau, h√£y t·∫°o m√£ ngu·ªìn ho√†n ch·ªânh cho T·∫§T C·∫¢ c√°c t·ªáp.
            K·∫æ HO·∫†CH: ${JSON.stringify(proposedPlan)}
            PHONG C√ÅCH THI·∫æT K·∫æ B·∫ÆT BU·ªòC: "${designContext}"
            Y√™u c·∫ßu: ƒê·∫£m b·∫£o c√°c trang HTML c√≥ thanh ƒëi·ªÅu h∆∞·ªõng li√™n k·∫øt ƒë·∫øn c√°c trang HTML kh√°c. T·∫•t c·∫£ c√°c trang HTML ph·∫£i li√™n k·∫øt ƒë·∫øn t·ªáp style.css. T·ªáp style.css ph·∫£i ƒë∆∞·ª£c vi·∫øt m·ªôt c√°ch chuy√™n nghi·ªáp, ch·ª©a c√°c ki·ªÉu d√°ng hi·ªán ƒë·∫°i, c√°c hi·ªáu ·ª©ng hover tinh t·∫ø, v√† tu√¢n th·ªß nghi√™m ng·∫∑t phong c√°ch thi·∫øt k·∫ø ƒë√£ cho. Tr·∫£ l·ªùi D∆Ø·ªöI D·∫†NG m·ªôt ƒë·ªëi t∆∞·ª£ng JSON duy nh·∫•t, trong ƒë√≥ key l√† t√™n t·ªáp v√† value l√† m√£ ngu·ªìn t∆∞∆°ng ·ª©ng.`;

            try {
                const result = await aiModel.generateContent(instruction);
                const jsonString = (await result.response).text().replace(/```json|```/g, '').trim();
                const filesData = JSON.parse(jsonString);

                const filesToSave = new Map(Object.entries(filesData));
                await saveMultiFileVerson(filesToSave, `AI Architect: ${proposedPlan.description.substring(0, 50)}...`);
                
                elements.aiPlanModal.classList.add('hidden');
            } catch (e) {
                console.error("L·ªói khi x√¢y d·ª±ng c·∫•u tr√∫c:", e);
                showMessage("AI ƒë√£ g·∫∑p l·ªói khi x√¢y d·ª±ng d·ª± √°n. Vui l√≤ng th·ª≠ l·∫°i.");
            } finally {
                btnText.textContent = 'B·∫Øt ƒë·∫ßu x√¢y d·ª±ng';
                spinner.classList.add('hidden');
                elements.confirmAiPlanBtn.disabled = false;
                proposedPlan = null;
            }
        };

        const handleVisualEdit = async (prompt, designContext) => {
            const instruction = `B·∫°n l√† m·ªôt l·∫≠p tr√¨nh vi√™n frontend. C·∫≠p nh·∫≠t m√£ HTML sau.
            Y√äU C·∫¶U: √Åp d·ª•ng thay ƒë·ªïi "${prompt}" cho ph·∫ßn t·ª≠ ƒë∆∞·ª£c x√°c ƒë·ªãnh b·ªüi b·ªô ch·ªçn CSS "${lastSelectedElementSelector}".
            PHONG C√ÅCH THI·∫æT K·∫æ: "${designContext}".
            L∆ØU √ù: N·∫øu y√™u c·∫ßu c·∫ßn t∆∞∆°ng t√°c (v√≠ d·ª•: nh·∫•p chu·ªôt, hi·ªáu ·ª©ng), h√£y bao g·ªìm m√£ JavaScript c·∫ßn thi·∫øt trong th·∫ª <script>. Tr·∫£ v·ªÅ TO√ÄN B·ªò m√£ HTML ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t, kh√¥ng gi·∫£i th√≠ch.
            M√É HI·ªÜN T·∫†I:\n\n${elements.editableCodeContent.textContent}`;
            const result = await aiModel.generateContent(instruction);
            const updatedCode = (await result.response).text().replace(/```html|```/g, '').trim();
            const updatedFiles = new Map(currentFiles);
            const currentFilename = [...currentFiles.keys()].find(key => currentFiles.get(key) === elements.editableCodeContent.textContent) || 'index.html';
            updatedFiles.set(currentFilename, updatedCode);
            await saveMultiFileVerson(updatedFiles, `AI Edit: ${prompt}`);
        };

        const handleGeneralModification = async (prompt, designContext) => {
            const fileContext = JSON.stringify(Object.fromEntries(currentFiles));
            const instruction = `B·∫°n l√† m·ªôt l·∫≠p tr√¨nh vi√™n web. D·ª±a tr√™n c√°c t·ªáp hi·ªán c√≥, h√£y th·ª±c hi·ªán y√™u c·∫ßu sau.
            Y√äU C·∫¶U: "${prompt}".
            PHONG C√ÅCH THI·∫æT K·∫æ: "${designContext}".
            C√ÅC T·ªÜP HI·ªÜN C√ì: ${fileContext}.
            Nhi·ªám v·ª•: Tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng JSON ch·ª©a c√°c t·ªáp ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t. Ch·ªâ tr·∫£ v·ªÅ JSON.`;
            const result = await aiModel.generateContent(instruction);
            const jsonString = (await result.response).text().replace(/```json|```/g, '').trim();
            const filesData = JSON.parse(jsonString);
            const filesToSave = new Map(Object.entries(filesData));
            await saveMultiFileVerson(filesToSave, `AI Modify: ${prompt.substring(0, 50)}...`);
        };
        
        const handleGlobalStyleRequest = async () => {
            const userPrompt = elements.globalStylePromptInput.value.trim();
            if (!userPrompt || !currentAppId) return;
            
            setGlobalStyleLoading(true);
            const designContext = getDesignStyleContext();

            try {
                const cssFilename = 'style.css';
                const currentCss = currentFiles.get(cssFilename) || '/* CSS Styles */';
                const instruction = `B·∫°n l√† m·ªôt nh√† thi·∫øt k·∫ø web. C·∫≠p nh·∫≠t t·ªáp CSS sau ƒë√¢y.
                Y√äU C·∫¶U: "${userPrompt}".
                PHONG C√ÅCH THI·∫æT K·∫æ CH·ª¶ ƒê·∫†O: "${designContext}".
                L∆ØU √ù: H√£y k·∫øt h·ª£p y√™u c·∫ßu c·ªßa ng∆∞·ªùi d√πng v√†o phong c√°ch ch·ªß ƒë·∫°o m·ªôt c√°ch h√†i h√≤a. Ch·ªâ tr·∫£ v·ªÅ m√£ CSS, kh√¥ng gi·∫£i th√≠ch.
                CSS HI·ªÜN T·∫†I:\n${currentCss}`;
                
                const result = await aiModel.generateContent(instruction);
                const newCss = (await result.response).text().replace(/```css|```/g, '').trim();
                
                const updatedFiles = new Map(currentFiles);
                updatedFiles.set(cssFilename, newCss);
                
                for(const [filename, content] of updatedFiles.entries()) {
                    if (filename.endsWith('.html') && !content.includes(`<link rel="stylesheet" href="${cssFilename}">`)) {
                        updatedFiles.set(filename, content.replace('</head>', `  <link rel="stylesheet" href="${cssFilename}">\n</head>`));
                    }
                }
                await saveMultiFileVerson(updatedFiles, `AI Style: ${userPrompt}`);
                elements.globalStylePromptInput.value = '';
            } catch (error) {
                console.error("Error applying global style:", error);
                showMessage(`L·ªói khi √°p d·ª•ng phong c√°ch: ${error.message}`, 5000);
            } finally {
                setGlobalStyleLoading(false);
            }
        };

        // --- Event Listeners ---
        elements.loginBtn.addEventListener('click', () => handleAuth(false));
        elements.registerBtn.addEventListener('click', () => handleAuth(true));
        elements.logoutBtn.addEventListener('click', () => signOut(auth));
        elements.addNewAppBtn.addEventListener('click', () => elements.addNewAppModal.classList.remove('hidden'));
        elements.cancelNewAppBtn.addEventListener('click', () => elements.addNewAppModal.classList.add('hidden'));
        elements.confirmNewAppBtn.addEventListener('click', async () => {
            const appName = elements.newAppNameInput.value.trim();
            if(appName && userId) await addDoc(getCollections.applications(), { name: appName, createdAt: Date.now() });
            elements.addNewAppModal.classList.add('hidden');
        });
        elements.applicationsList.addEventListener('click', (e) => { if (e.target.dataset.appId) selectApplication(e.target.dataset.appId); });
        elements.changeHistoryList.addEventListener('click', (e) => { const item = e.target.closest('[data-version-id]'); if (item) selectVersion(currentAppId, item.dataset.versionId, false); });
        elements.myPagesList.addEventListener('click', (e) => { const item = e.target.closest('[data-filename]'); if (item) { elements.editableCodeContent.textContent = currentFiles.get(item.dataset.filename) || ''; showMessage(`ƒêang hi·ªÉn th·ªã trang: ${item.dataset.filename}`); } });
        elements.visualEditBtn.addEventListener('click', enterVisualEditMode);
        elements.closePreviewBtn.addEventListener('click', () => elements.previewModal.classList.add('hidden'));
        elements.sendToAIButton.addEventListener('click', handleAiRequest);
        elements.applyGlobalStyleBtn.addEventListener('click', handleGlobalStyleRequest);
        elements.confirmAiPlanBtn.addEventListener('click', handleScaffolding);
        elements.cancelAiPlanBtn.addEventListener('click', () => elements.aiPlanModal.classList.add('hidden'));
        window.addEventListener('message', (event) => { if (event.data.type === 'element-selected') { lastSelectedElementSelector = event.data.selector; elements.previewModal.classList.add('hidden'); elements.aiPromptInput.placeholder = `S·ª≠a ƒë·ªïi: "${lastSelectedElementSelector}"...`; elements.aiPromptInput.focus(); } });

    </script>
</body>
</html>
