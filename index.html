<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI No-Code Platform - Final Version</title>
    
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* CSS chung cho toàn bộ ứng dụng */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #d1d5db; /* text-gray-300 */
        }
        button { transition: all 0.3s ease; }
        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 6px 10px -1px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.08);
        }
        .list-item {
            transition: all 0.2s ease;
            border: 1px solid #374151; /* gray-700 */
        }
        .list-item:hover {
            background-color: #1f2937; /* gray-800 */
            border-color: #4f46e5; /* indigo-600 */
        }
        .list-item.selected {
             background-color: #3730a3; /* indigo-800 */
             border-left: 4px solid #6366f1; /* indigo-500 */
             border-color: #4f46e5; /* indigo-600 */
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #previewModal iframe { width: 100%; height: 100%; border: none; }
        #previewModal.visual-edit-mode #previewModalContent {
            width: 100vw;
            height: 100vh;
            max-width: 100vw;
            border-radius: 0;
        }
        /* Ẩn trình soạn thảo code theo mặc định, chỉ dùng để lưu trữ nội dung */
        #fileEditorGroup { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gray-800 text-white p-4 shadow-lg flex justify-between items-center border-b border-gray-700">
        <h1 class="text-3xl font-bold">No-Code AI Platform</h1>
        <div id="authStatus" class="flex items-center space-x-4">
            <span id="userEmailDisplay" class="text-lg font-medium hidden"></span>
            <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hidden">Đăng xuất</button>
        </div>
    </header>

    <!-- Auth Section -->
    <div id="authSection" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-md border border-gray-700">
            <h2 class="text-3xl font-bold mb-6 text-center text-white">Đăng nhập / Đăng ký</h2>
            <div class="mb-4">
                <label for="emailInput" class="block text-gray-300 text-base font-bold mb-2">Email:</label>
                <input type="email" id="emailInput" placeholder="your@example.com" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="mb-6">
                <label for="passwordInput" class="block text-gray-300 text-base font-bold mb-2">Mật khẩu:</label>
                <input type="password" id="passwordInput" placeholder="********" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="loginBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg shadow-md flex-grow">Đăng nhập</button>
                <button id="registerBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg shadow-md flex-grow">Đăng ký</button>
            </div>
            <p class="text-red-500 text-sm mt-4 text-center" id="authErrorMsg"></p>
        </div>
    </div>

    <!-- Main App Content -->
    <main id="mainAppContent" class="flex-grow container mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 hidden">
        
        <!-- Cột Trái: Quản lý dự án -->
        <section class="bg-gray-800 p-6 rounded-lg shadow-md col-span-1 lg:col-span-3 flex flex-col border border-gray-700 space-y-6">
            <!-- Applications Section -->
            <div>
                <h2 class="text-2xl font-semibold mb-4 text-white">Applications</h2>
                <button id="addNewAppBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md mb-4 w-full">Tạo ứng dụng mới</button>
                <div id="applicationsList" class="space-y-3 max-h-40 overflow-y-auto pr-2">
                    <div class="text-gray-400 text-center py-4">Đang tải...</div>
                </div>
            </div>
            
            <!-- Giai đoạn 2: My Pages Section -->
            <div id="myPagesSection" class="border-t border-gray-700 pt-6">
                <h2 class="text-2xl font-semibold mb-4 text-white">Các trang của tôi</h2>
                <div id="myPagesList" class="space-y-3 max-h-40 overflow-y-auto pr-2">
                    <div class="text-gray-400 text-center py-4">Chọn một ứng dụng</div>
                </div>
            </div>

            <!-- Giai đoạn 2: Change History Section -->
            <div id="changeHistorySection" class="border-t border-gray-700 pt-6 flex-grow flex flex-col">
                <h2 class="text-2xl font-semibold mb-4 text-white">Lịch sử thay đổi</h2>
                <div id="changeHistoryList" class="space-y-3 flex-grow overflow-y-auto pr-2">
                     <div class="text-gray-400 text-center py-4">Chọn một ứng dụng</div>
                </div>
            </div>
        </section>

        <!-- Cột phải: AI Canvas -->
        <section class="bg-gray-800 p-8 rounded-xl shadow-2xl col-span-1 lg:col-span-9 flex flex-col border border-gray-700">
            
            <!-- Giai đoạn 1: Visual Edit Button -->
            <div class="text-center mb-6">
                 <button id="visualEditBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-4 px-8 rounded-lg shadow-lg text-lg w-full">Chế độ Chỉnh sửa Trực quan</button>
            </div>
            
            <!-- Giai đoạn 2: AI "Designer" -->
            <div id="globalStyleSection" class="bg-gray-900 p-6 rounded-xl border border-gray-700 shadow-lg mb-6">
                 <label for="globalStylePromptInput" class="block text-gray-300 text-base font-bold mb-2">Phong cách & Chủ đề Toàn cục</label>
                 <textarea id="globalStylePromptInput" rows="2" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="VD: 'dùng tông màu tối cho toàn bộ trang web' hoặc 'đổi font chữ thành Arial'"></textarea>
                 <button id="applyGlobalStyleBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md mt-2 w-full">Áp dụng cho toàn bộ trang</button>
            </div>

            <!-- Giai đoạn 3: AI "Architect" Prompt -->
            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700 shadow-lg flex-grow flex flex-col">
                 <label for="aiPromptInput" class="block text-gray-300 text-base font-bold mb-2">Yêu cầu cho AI Kiến trúc sư</label>
                 <textarea id="aiPromptInput" rows="3" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 flex-grow" placeholder="Mô tả ý tưởng của bạn... VD: 'làm cho tôi một trang portfolio nhiếp ảnh' hoặc 'tạo một blog du lịch'"></textarea>
                 <button id="sendToAIButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg shadow-md mt-4 w-full flex items-center justify-center gap-2">
                    <span id="aiButtonText">Gửi tới AI</span>
                    <div id="aiButtonSpinner" class="spinner hidden"></div>
                </button>
            </div>

            <!-- Hidden Code Editor -->
            <div id="fileEditorGroup"><code id="editableCodeContent"></code></div>
        </section>
    </main>

    <!-- Modals -->
    <div id="messageBox" class="fixed bottom-4 right-4 bg-gray-200 text-gray-900 px-6 py-3 rounded-lg shadow-lg hidden z-50 opacity-0"></div>
    <div id="addNewAppModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-md border border-gray-700">
            <h3 class="text-2xl font-bold mb-6 text-white">Tạo ứng dụng mới</h3>
            <div class="mb-4">
                <label for="newAppNameInput" class="block text-gray-300 text-base font-bold mb-2">Tên ứng dụng:</label>
                <input type="text" id="newAppNameInput" placeholder="Ví dụ: 'Blog cá nhân'" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancelNewAppBtn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Hủy</button>
                <button id="confirmNewAppBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Tạo</button>
            </div>
        </div>
    </div>
    <div id="previewModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-0 hidden z-50">
        <div id="previewModalContent" class="bg-white rounded-lg shadow-2xl w-full h-full flex flex-col relative"> 
            <button id="closePreviewBtn" class="absolute top-4 right-4 text-white bg-black bg-opacity-50 hover:bg-opacity-75 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold z-20">&times;</button>
            <iframe id="previewFrame" title="Visual Edit Content"></iframe>
        </div>
    </div>
    
    <!-- Giai đoạn 3: AI Plan Confirmation Modal -->
    <div id="aiPlanModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-2xl border border-gray-700">
            <h3 class="text-2xl font-bold mb-4 text-white">Kế hoạch của AI Kiến trúc sư</h3>
            <p id="aiPlanDescription" class="text-gray-300 mb-6"></p>
            <div id="aiPlanFiles" class="space-y-3 mb-6 border-t border-b border-gray-700 py-4"></div>
            <div class="flex justify-end gap-4">
                <button id="cancelAiPlanBtn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Hủy</button>
                <button id="confirmAiPlanBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                    <span id="confirmAiPlanBtnText">Bắt đầu xây dựng</span>
                    <div id="confirmAiPlanSpinner" class="spinner hidden"></div>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase and AI SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, getDoc, onSnapshot, query, orderBy, setDoc, updateDoc, deleteDoc, where, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-ai.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDn5kQei_GxhUCJ4i1CVytiWla3vqpVGWI",
            authDomain: "aicodepro.firebaseapp.com",
            projectId: "aicodepro",
            storageBucket: "aicodepro.firebasestorage.app",
            messagingSenderId: "905071307012",
            appId: "1:905071307012:web:c242d96fb6aa4807154851"
        };

        // Initialize Firebase and AI Model
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let aiModel;
        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            aiModel = getGenerativeModel(ai, { model: "gemini-1.5-flash" });
        } catch (e) { console.error("AI Init Error:", e); }

        // Global State
        let currentAppId = null, currentVersionId = null, userId = null;
        let currentFiles = new Map();
        let lastSelectedElementSelector = null;
        let proposedPlan = null;

        // DOM Elements
        const elements = {
            authSection: document.getElementById('authSection'), mainAppContent: document.getElementById('mainAppContent'),
            emailInput: document.getElementById('emailInput'), passwordInput: document.getElementById('passwordInput'),
            loginBtn: document.getElementById('loginBtn'), registerBtn: document.getElementById('registerBtn'),
            logoutBtn: document.getElementById('logoutBtn'), userEmailDisplay: document.getElementById('userEmailDisplay'),
            applicationsList: document.getElementById('applicationsList'), myPagesList: document.getElementById('myPagesList'),
            changeHistoryList: document.getElementById('changeHistoryList'), visualEditBtn: document.getElementById('visualEditBtn'),
            globalStylePromptInput: document.getElementById('globalStylePromptInput'), applyGlobalStyleBtn: document.getElementById('applyGlobalStyleBtn'),
            aiPromptInput: document.getElementById('aiPromptInput'), sendToAIButton: document.getElementById('sendToAIButton'),
            aiButtonText: document.getElementById('aiButtonText'), aiButtonSpinner: document.getElementById('aiButtonSpinner'),
            editableCodeContent: document.getElementById('editableCodeContent'), messageBox: document.getElementById('messageBox'),
            messageContent: document.getElementById('messageContent'), addNewAppBtn: document.getElementById('addNewAppBtn'),
            addNewAppModal: document.getElementById('addNewAppModal'), newAppNameInput: document.getElementById('newAppNameInput'),
            confirmNewAppBtn: document.getElementById('confirmNewAppBtn'), cancelNewAppBtn: document.getElementById('cancelNewAppBtn'),
            previewModal: document.getElementById('previewModal'), closePreviewBtn: document.getElementById('closePreviewBtn'),
            previewFrame: document.getElementById('previewFrame'), aiPlanModal: document.getElementById('aiPlanModal'),
            aiPlanDescription: document.getElementById('aiPlanDescription'), aiPlanFiles: document.getElementById('aiPlanFiles'),
            confirmAiPlanBtn: document.getElementById('confirmAiPlanBtn'), cancelAiPlanBtn: document.getElementById('cancelAiPlanBtn'),
            confirmAiPlanBtnText: document.getElementById('confirmAiPlanBtnText'), confirmAiPlanSpinner: document.getElementById('confirmAiPlanSpinner'),
        };

        // --- Utility Functions ---
        function showMessage(msg, duration = 3000) {
            elements.messageContent.textContent = msg;
            elements.messageBox.classList.remove('hidden', 'opacity-0');
            elements.messageBox.classList.add('opacity-100');
            setTimeout(() => {
                elements.messageBox.classList.remove('opacity-100');
                setTimeout(() => elements.messageBox.classList.add('hidden'), 300);
            }, duration);
        }

        function setMainAiLoading(isLoading, text = 'Gửi tới AI') {
            elements.aiButtonText.textContent = text;
            elements.aiButtonSpinner.classList.toggle('hidden', !isLoading);
            elements.sendToAIButton.disabled = isLoading;
            // Disable other button to prevent concurrent requests
            elements.applyGlobalStyleBtn.disabled = isLoading;
        }

        // BUG FIX: Separate loading state for the global style button
        function setGlobalStyleLoading(isLoading) {
            const btn = elements.applyGlobalStyleBtn;
            btn.disabled = isLoading;
            if (isLoading) {
                btn.innerHTML = `<div class="flex items-center justify-center gap-2"><span>Đang thiết kế...</span><div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div></div>`;
            } else {
                btn.textContent = 'Áp dụng cho toàn bộ trang';
            }
            // Disable other button to prevent concurrent requests
            elements.sendToAIButton.disabled = isLoading;
        }

        // --- Authentication ---
        onAuthStateChanged(auth, user => {
            const isLoggedIn = !!user;
            elements.authSection.classList.toggle('hidden', isLoggedIn);
            elements.mainAppContent.classList.toggle('hidden', !isLoggedIn);
            if (isLoggedIn) {
                userId = user.uid;
                elements.userEmailDisplay.textContent = user.email || "Anonymous";
                loadApplications();
            } else {
                userId = null;
            }
            elements.userEmailDisplay.classList.toggle('hidden', !isLoggedIn);
            elements.logoutBtn.classList.toggle('hidden', !isLoggedIn);
        });
        
        const handleAuth = async (isRegister) => {
            const email = elements.emailInput.value.trim();
            const password = elements.passwordInput.value.trim();
            try {
                if (isRegister) await createUserWithEmailAndPassword(auth, email, password);
                else await signInWithEmailAndPassword(auth, email, password);
            } catch (error) { showMessage(error.message); }
        };

        // --- Firestore Data Management ---
        const getCollections = {
            applications: () => collection(db, `users/${userId}/applications`),
            versions: (appId) => collection(db, `users/${userId}/applications/${appId}/versions`),
            files: (appId, versionId) => collection(db, `users/${userId}/applications/${appId}/versions/${versionId}/files`)
        };

        const loadApplications = () => {
            if (!userId) return;
            const q = query(getCollections.applications(), orderBy('createdAt', 'desc'));
            onSnapshot(q, snapshot => {
                elements.applicationsList.innerHTML = snapshot.empty ? '<div class="text-gray-400 text-center py-4">Tạo ứng dụng đầu tiên.</div>' : '';
                snapshot.forEach(doc => {
                    const appData = { id: doc.id, ...doc.data() };
                    const appItem = document.createElement('div');
                    appItem.className = `list-item p-3 rounded-lg cursor-pointer`;
                    if (appData.id === currentAppId) appItem.classList.add('selected');
                    appItem.dataset.appId = appData.id;
                    appItem.textContent = appData.name;
                    elements.applicationsList.appendChild(appItem);
                });
            });
        };

        const selectApplication = (appId) => {
            currentAppId = appId;
            document.querySelectorAll('#applicationsList > div').forEach(el => el.classList.remove('selected'));
            document.querySelector(`#applicationsList [data-app-id="${appId}"]`).classList.add('selected');
            loadPagesAndHistory(appId);
        };

        const loadPagesAndHistory = (appId) => {
            if (!userId || !appId) return;
            const q = query(getCollections.versions(appId), orderBy('timestamp', 'desc'));
            onSnapshot(q, async (snapshot) => {
                elements.changeHistoryList.innerHTML = snapshot.empty ? '<div class="text-gray-400 text-center py-4">Chưa có thay đổi.</div>' : '';
                snapshot.forEach(doc => {
                    const version = doc.data();
                    const item = document.createElement('div');
                    item.className = 'list-item p-3 rounded-lg cursor-pointer';
                    if (doc.id === currentVersionId) item.classList.add('selected');
                    item.dataset.versionId = doc.id;
                    item.innerHTML = `<p class="font-medium text-gray-300 text-sm">${version.notes || 'Thay đổi nhỏ'}</p><p class="text-xs text-gray-500">${new Date(version.timestamp).toLocaleString()}</p>`;
                    elements.changeHistoryList.appendChild(item);
                });

                if (!snapshot.empty) {
                    const latestVersionId = snapshot.docs[0].id;
                    if (currentVersionId !== latestVersionId) {
                        await selectVersion(appId, latestVersionId, true);
                    }
                } else {
                    renderMyPages(); // Clear pages list if no versions
                }
            });
        };

        const selectVersion = async (appId, versionId, isLatest = false) => {
            currentVersionId = versionId;
            document.querySelectorAll('#changeHistoryList > div').forEach(el => el.classList.remove('selected'));
            const versionElement = document.querySelector(`#changeHistoryList [data-version-id="${versionId}"]`);
            if(versionElement) versionElement.classList.add('selected');

            const filesSnapshot = await getDocs(getCollections.files(appId, versionId));
            currentFiles.clear();
            filesSnapshot.forEach(doc => currentFiles.set(doc.data().filename, doc.data().content));
            
            const firstPageName = [...currentFiles.keys()].find(k => k.endsWith('.html')) || '';
            elements.editableCodeContent.textContent = currentFiles.get(firstPageName) || '';

            if (isLatest) {
                renderMyPages();
            }
        };
        
        const renderMyPages = () => {
            elements.myPagesList.innerHTML = '';
            const htmlFiles = [...currentFiles.keys()].filter(k => k.endsWith('.html'));
            if (htmlFiles.length === 0) {
                 elements.myPagesList.innerHTML = '<div class="text-gray-400 text-center py-4">Chưa có trang nào.</div>';
                 return;
            }
            htmlFiles.forEach(filename => {
                const pageItem = document.createElement('div');
                pageItem.className = 'list-item p-3 rounded-lg cursor-pointer';
                pageItem.textContent = filename;
                pageItem.dataset.filename = filename;
                elements.myPagesList.appendChild(pageItem);
            });
        };

        const saveMultiFileVerson = async (filesMap, note) => {
            if (!userId || !currentAppId) return showMessage("Vui lòng chọn một ứng dụng.");
            
            const batch = writeBatch(db);
            const versionsQuery = query(getCollections.versions(currentAppId));
            const versionsSnapshot = await getDocs(versionsQuery);
            const newVersionIndex = versionsSnapshot.size + 1;
            
            const newVersionRef = doc(collection(db, `users/${userId}/applications/${currentAppId}/versions`));
            batch.set(newVersionRef, {
                versionIndex: newVersionIndex, notes: note, timestamp: Date.now(), parentVersionId: currentVersionId,
            });

            for (const [filename, content] of filesMap.entries()) {
                const fileRef = doc(collection(db, `users/${userId}/applications/${currentAppId}/versions/${newVersionRef.id}/files`));
                batch.set(fileRef, { filename, content });
            }
            
            await batch.commit();
            showMessage(`Đã lưu phiên bản mới: ${note}`);
        };

        // --- Giai đoạn 1: Visual Editing ---
        function createInjectorScript() {
            return `
                let highlightedElement = null;
                const highlightStyle = 'outline: 3px solid #00BFFF; outline-offset: 2px; box-shadow: 0 0 15px rgba(0, 191, 255, 0.8); cursor: pointer; border-radius: 4px; transition: all 0.1s ease-in-out;';
                function getCssPath(el) {
                    if (!(el instanceof Element)) return; let path = [];
                    while (el.nodeType === Node.ELEMENT_NODE) {
                        let selector = el.nodeName.toLowerCase();
                        if (el.id) { selector += '#' + el.id; path.unshift(selector); break; }
                        else { let sib = el, nth = 1; while (sib = sib.previousElementSibling) { if (sib.nodeName.toLowerCase() == selector) nth++; } if (nth != 1) selector += ":nth-of-type("+nth+")"; }
                        path.unshift(selector); el = el.parentNode;
                    } return path.join(" > ");
                }
                document.body.addEventListener('mouseover', e => { if (highlightedElement) { highlightedElement.style.cssText = highlightedElement.style.cssText.replace(highlightStyle, ''); } highlightedElement = e.target; highlightedElement.style.cssText += highlightStyle; });
                document.body.addEventListener('mouseout', e => { if (highlightedElement) { highlightedElement.style.cssText = highlightedElement.style.cssText.replace(highlightStyle, ''); highlightedElement = null; } });
                document.body.addEventListener('click', e => { e.preventDefault(); e.stopPropagation(); const selector = getCssPath(e.target); window.parent.postMessage({ type: 'element-selected', selector: selector }, '*'); }, true);
            `;
        }
        
        const enterVisualEditMode = () => {
            const codeToPreview = elements.editableCodeContent.textContent;
            if (!codeToPreview) return showMessage("Không có mã để chỉnh sửa.");
            const injectorScript = createInjectorScript();
            let finalCode = codeToPreview;
            if (!finalCode.includes('cdn.tailwindcss.com')) {
                 finalCode = finalCode.replace('</head>', '<script src="https://cdn.tailwindcss.com"><\/script></head>');
            }
            elements.previewFrame.srcdoc = `${finalCode}<script>${injectorScript}<\/script>`;
            elements.previewModal.classList.add('visual-edit-mode');
            elements.previewModal.classList.remove('hidden');
        };

        // --- Giai đoạn 3: AI Architect & Other AI Handlers ---
        const isMajorProjectRequest = (prompt) => {
            const keywords = ['website', 'trang web', 'portfolio', 'blog', 'cửa hàng', 'shop', 'dự án', 'platform'];
            return keywords.some(keyword => prompt.toLowerCase().includes(keyword));
        };

        const handleAiRequest = async () => {
            const userPrompt = elements.aiPromptInput.value.trim();
            if (!userPrompt) return showMessage("Vui lòng nhập yêu cầu.");
            if (!currentAppId) return showMessage("Vui lòng tạo hoặc chọn một ứng dụng trước.");
            
            setMainAiLoading(true, 'AI đang suy nghĩ...');

            try {
                if (lastSelectedElementSelector) {
                    await handleVisualEdit(userPrompt);
                } else if (isMajorProjectRequest(userPrompt)) {
                    await handleProjectPlanning(userPrompt);
                } else {
                    await handleGeneralModification(userPrompt);
                }
            } catch (error) {
                console.error("AI Error:", error);
                showMessage(`Lỗi AI: ${error.message}`, 5000);
            } finally {
                setMainAiLoading(false);
                lastSelectedElementSelector = null;
                elements.aiPromptInput.value = '';
                elements.aiPromptInput.placeholder = "Mô tả ý tưởng của bạn...";
            }
        };

        const handleProjectPlanning = async (prompt) => {
            const instruction = `Bạn là một kiến trúc sư web. Phân tích yêu cầu của người dùng và đề xuất một kế hoạch xây dựng trang web. Kế hoạch phải bao gồm danh sách các tệp (HTML và một tệp CSS chung) và mô tả ngắn gọn cho mỗi tệp. Trả lời DƯỚI DẠNG một đối tượng JSON duy nhất. JSON phải có thuộc tính "description" (lời chào và mô tả kế hoạch) và "files" (một mảng các đối tượng, mỗi đối tượng có "name" và "purpose"). Yêu cầu người dùng: "${prompt}"`;
            
            try {
                const result = await aiModel.generateContent(instruction);
                const jsonString = (await result.response).text().replace(/```json|```/g, '').trim();
                proposedPlan = JSON.parse(jsonString);
                
                elements.aiPlanDescription.textContent = proposedPlan.description;
                elements.aiPlanFiles.innerHTML = '';
                proposedPlan.files.forEach(file => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'bg-gray-700 p-3 rounded-md';
                    fileDiv.innerHTML = `<p class="font-semibold text-white">${file.name}</p><p class="text-sm text-gray-400">${file.purpose}</p>`;
                    elements.aiPlanFiles.appendChild(fileDiv);
                });
                elements.aiPlanModal.classList.remove('hidden');

            } catch (e) {
                console.error("Lỗi khi lập kế hoạch:", e);
                showMessage("AI không thể lập kế hoạch. Vui lòng thử một yêu cầu khác rõ ràng hơn.");
            } finally {
                setMainAiLoading(false);
            }
        };
        
        const handleScaffolding = async () => {
            if (!proposedPlan) return;
            const btnText = elements.confirmAiPlanBtnText;
            const spinner = elements.confirmAiPlanSpinner;
            btnText.textContent = 'Đang xây dựng...';
            spinner.classList.remove('hidden');
            elements.confirmAiPlanBtn.disabled = true;

            const instruction = `Bạn là một lập trình viên web chuyên nghiệp. Dựa trên kế hoạch sau, hãy tạo mã nguồn hoàn chỉnh cho TẤT CẢ các tệp. Đảm bảo các trang HTML có thanh điều hướng liên kết đến các trang HTML khác trong kế hoạch. Tất cả các trang HTML phải liên kết đến tệp style.css. Tệp style.css phải chứa các kiểu dáng hiện đại, phù hợp với mục đích của trang web. Trả lời DƯỚI DẠNG một đối tượng JSON duy nhất, trong đó key là tên tệp và value là mã nguồn tương ứng. Kế hoạch: ${JSON.stringify(proposedPlan)}`;

            try {
                const result = await aiModel.generateContent(instruction);
                const jsonString = (await result.response).text().replace(/```json|```/g, '').trim();
                const filesData = JSON.parse(jsonString);

                const filesToSave = new Map(Object.entries(filesData));
                await saveMultiFileVerson(filesToSave, `AI Architect: ${proposedPlan.description.substring(0, 50)}...`);
                
                elements.aiPlanModal.classList.add('hidden');
            } catch (e) {
                console.error("Lỗi khi xây dựng cấu trúc:", e);
                showMessage("AI đã gặp lỗi khi xây dựng dự án. Vui lòng thử lại.");
            } finally {
                btnText.textContent = 'Bắt đầu xây dựng';
                spinner.classList.add('hidden');
                elements.confirmAiPlanBtn.disabled = false;
                proposedPlan = null;
            }
        };

        const handleVisualEdit = async (prompt) => {
            const instruction = `Cập nhật mã HTML sau. Áp dụng thay đổi "${prompt}" cho phần tử được xác định bởi bộ chọn CSS "${lastSelectedElementSelector}". Nếu yêu cầu cần tương tác (ví dụ: nhấp chuột, hiệu ứng), hãy bao gồm mã JavaScript cần thiết trong thẻ <script>. Trả về TOÀN BỘ mã HTML đã được cập nhật, không giải thích. Mã hiện tại:\n\n${elements.editableCodeContent.textContent}`;
            const result = await aiModel.generateContent(instruction);
            const updatedCode = (await result.response).text().replace(/```html|```/g, '').trim();
            const updatedFiles = new Map(currentFiles);
            const currentFilename = [...currentFiles.keys()].find(key => currentFiles.get(key) === elements.editableCodeContent.textContent) || 'index.html';
            updatedFiles.set(currentFilename, updatedCode);
            await saveMultiFileVerson(updatedFiles, `AI Edit: ${prompt}`);
        };

        const handleGeneralModification = async (prompt) => {
            const fileContext = JSON.stringify(Object.fromEntries(currentFiles));
            const instruction = `Bạn là một lập trình viên web. Dựa trên các tệp hiện có, hãy thực hiện yêu cầu sau: "${prompt}". Các tệp hiện có là: ${fileContext}. Trả về một đối tượng JSON chứa các tệp đã được cập nhật. Chỉ trả về JSON.`;
            const result = await aiModel.generateContent(instruction);
            const jsonString = (await result.response).text().replace(/```json|```/g, '').trim();
            const filesData = JSON.parse(jsonString);
            const filesToSave = new Map(Object.entries(filesData));
            await saveMultiFileVerson(filesToSave, `AI Modify: ${prompt.substring(0, 50)}...`);
        };
        
        // BUG FIX: Added try...catch...finally block
        const handleGlobalStyleRequest = async () => {
            const userPrompt = elements.globalStylePromptInput.value.trim();
            if (!userPrompt || !currentAppId) {
                return showMessage("Vui lòng chọn một ứng dụng và nhập yêu cầu về phong cách.");
            }
            
            setGlobalStyleLoading(true);

            try {
                const cssFilename = 'style.css';
                const currentCss = currentFiles.get(cssFilename) || '/* CSS Styles */';
                const instruction = `Bạn là một nhà thiết kế web. Cập nhật tệp CSS sau đây để áp dụng phong cách "${userPrompt}". Chỉ trả về mã CSS, không giải thích. \n\nCSS hiện tại:\n${currentCss}`;
                
                const result = await aiModel.generateContent(instruction);
                const newCss = (await result.response).text().replace(/```css|```/g, '').trim();
                
                const updatedFiles = new Map(currentFiles);
                updatedFiles.set(cssFilename, newCss);
                
                for(const [filename, content] of updatedFiles.entries()) {
                    if (filename.endsWith('.html') && !content.includes(`<link rel="stylesheet" href="${cssFilename}">`)) {
                        updatedFiles.set(filename, content.replace('</head>', `  <link rel="stylesheet" href="${cssFilename}">\n</head>`));
                    }
                }
                await saveMultiFileVerson(updatedFiles, `AI Style: ${userPrompt}`);
                elements.globalStylePromptInput.value = '';
            } catch (error) {
                console.error("Error applying global style:", error);
                showMessage(`Lỗi khi áp dụng phong cách: ${error.message}`, 5000);
            } finally {
                setGlobalStyleLoading(false);
            }
        };

        // --- Event Listeners ---
        elements.loginBtn.addEventListener('click', () => handleAuth(false));
        elements.registerBtn.addEventListener('click', () => handleAuth(true));
        elements.logoutBtn.addEventListener('click', () => signOut(auth));
        elements.addNewAppBtn.addEventListener('click', () => elements.addNewAppModal.classList.remove('hidden'));
        elements.cancelNewAppBtn.addEventListener('click', () => elements.addNewAppModal.classList.add('hidden'));
        elements.confirmNewAppBtn.addEventListener('click', async () => {
            const appName = elements.newAppNameInput.value.trim();
            if(appName && userId) await addDoc(getCollections.applications(), { name: appName, createdAt: Date.now() });
            elements.addNewAppModal.classList.add('hidden');
        });
        elements.applicationsList.addEventListener('click', (e) => { if (e.target.dataset.appId) selectApplication(e.target.dataset.appId); });
        elements.changeHistoryList.addEventListener('click', (e) => { const item = e.target.closest('[data-version-id]'); if (item) selectVersion(currentAppId, item.dataset.versionId, false); });
        elements.myPagesList.addEventListener('click', (e) => { const item = e.target.closest('[data-filename]'); if (item) { elements.editableCodeContent.textContent = currentFiles.get(item.dataset.filename) || ''; showMessage(`Đang hiển thị trang: ${item.dataset.filename}`); } });
        elements.visualEditBtn.addEventListener('click', enterVisualEditMode);
        elements.closePreviewBtn.addEventListener('click', () => elements.previewModal.classList.add('hidden'));
        elements.sendToAIButton.addEventListener('click', handleAiRequest);
        elements.applyGlobalStyleBtn.addEventListener('click', handleGlobalStyleRequest);
        elements.confirmAiPlanBtn.addEventListener('click', handleScaffolding);
        elements.cancelAiPlanBtn.addEventListener('click', () => elements.aiPlanModal.classList.add('hidden'));
        window.addEventListener('message', (event) => { if (event.data.type === 'element-selected') { lastSelectedElementSelector = event.data.selector; elements.previewModal.classList.add('hidden'); elements.aiPromptInput.placeholder = `Sửa đổi: "${lastSelectedElementSelector}"...`; elements.aiPromptInput.focus(); } });

    </script>
</body>
</html>
